<!DOCTYPE html>
<html lang="en" x-data="{ darkMode: false }" :class="{ 'dark': darkMode }">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dashboard - Scholar Lite</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
  <style>
    /* Smooth transitions and fade-in animations */
    * { transition: all 0.3s ease; }
    .animate-fadeIn { animation: fadeIn 0.5s ease forwards; }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }
  </style>
</head>
<body class="min-h-screen bg-gray-50 dark:bg-gray-900 text-gray-900 dark:text-gray-100 flex flex-col">

  <!-- Navbar -->
  <nav class="bg-white dark:bg-gray-800 shadow-md sticky top-0 z-50">
    <div class="max-w-6xl mx-auto px-4 flex justify-between items-center h-16">
      <a href="index.html" class="text-indigo-600 dark:text-indigo-400 font-bold text-xl">📚 Scholar Lite</a>
      <div class="flex items-center gap-4">
        <a href="index.html" class="text-gray-600 dark:text-gray-300 hover:text-indigo-600 dark:hover:text-indigo-400">Search</a>
        <a href="upload.html" class="text-gray-600 dark:text-gray-300 hover:text-indigo-600 dark:hover:text-indigo-400">Upload</a>
        <a href="dashboard.html" class="bg-indigo-600 text-white px-4 py-2 rounded-xl font-semibold shadow hover:bg-indigo-700 transition">Dashboard</a>

        <!-- Profile Preview -->
        <a href="profile.html" class="flex items-center gap-2">
          <img id="navAvatar" src="https://via.placeholder.com/40" alt="Profile" class="w-10 h-10 rounded-full border border-gray-300 dark:border-gray-600">
          <span id="navName" class="font-medium hidden sm:inline">Guest</span>
        </a>

        <!-- Dark Mode Toggle -->
        <button @click="darkMode = !darkMode" class="ml-4 p-2 rounded-lg bg-gray-200 dark:bg-gray-700 hover:scale-110 transition">
          <span x-show="!darkMode">🌙</span>
          <span x-show="darkMode">☀️</span>
        </button>
      </div>
    </div>
  </nav>

  <!-- Main Content -->
  <div class="flex-grow px-6 py-10" x-data="paperDashboard()">

    <!-- Profile Card -->
    <section class="bg-white dark:bg-gray-800 rounded-2xl p-6 shadow mb-8 flex items-center gap-6">
      <img id="dashAvatar" src="https://via.placeholder.com/80" class="w-20 h-20 rounded-full object-cover border border-gray-300 dark:border-gray-600">
      <div>
        <h2 id="dashName" class="text-2xl font-bold">Welcome, Guest</h2>
        <p id="dashBio" class="text-gray-600 dark:text-gray-300">Your personal space for academic papers 📚</p>
      </div>
    </section>

    <!-- Analytics Section -->
    <div class="max-w-5xl mx-auto grid md:grid-cols-3 gap-4 mb-8">
      <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow text-center hover:scale-105 transition">
        <p class="text-gray-600 dark:text-gray-400">Total Papers</p>
        <h2 class="text-3xl font-bold text-indigo-600 dark:text-indigo-400" x-text="papers.length"></h2>
      </div>
      <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow text-center hover:scale-105 transition">
        <p class="text-gray-600 dark:text-gray-400">Papers This Year</p>
        <h2 class="text-3xl font-bold text-indigo-600 dark:text-indigo-400" x-text="papersThisYear()"></h2>
      </div>
      <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow text-center hover:scale-105 transition">
        <p class="text-gray-600 dark:text-gray-400">Top Tag</p>
        <h2 class="text-xl font-bold text-indigo-600 dark:text-indigo-400" x-text="topTag() || '—'"></h2>
      </div>
    </div>

    <!-- Search + Sort + Export -->
    <div class="max-w-5xl mx-auto mb-6 flex flex-col md:flex-row gap-4">
      <input type="text" placeholder="🔎 Search..." 
        class="flex-1 border border-gray-300 dark:border-gray-700 rounded-lg px-4 py-2 shadow-sm focus:outline-none focus:ring focus:ring-indigo-200 dark:bg-gray-800"
        x-model="search">

      <select x-model="sortBy" 
        class="border border-gray-300 dark:border-gray-700 rounded-lg px-4 py-2 shadow-sm focus:outline-none focus:ring focus:ring-indigo-200 dark:bg-gray-800">
        <option value="">Sort by...</option>
        <option value="title">Title</option>
        <option value="author">Author</option>
        <option value="year">Year</option>
      </select>

      <button @click="exportCSV()" class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg shadow">
        ⬇ Export CSV
      </button>
    </div>

    <!-- Filter by Tag -->
    <div class="max-w-5xl mx-auto mb-6">
      <label class="text-gray-700 dark:text-gray-300 font-semibold mr-2">Filter by Tag:</label>
      <select x-model="filterTag" 
        class="border border-gray-300 dark:border-gray-700 rounded-lg px-3 py-2 shadow-sm dark:bg-gray-800 focus:ring focus:ring-indigo-200">
        <option value="">All</option>
        <template x-for="tag in uniqueTags()" :key="tag">
          <option x-text="tag"></option>
        </template>
      </select>
    </div>

    <!-- Papers List -->
    <div class="bg-white dark:bg-gray-800 p-6 rounded-2xl shadow-lg max-w-5xl mx-auto w-full">
      <p x-show="filteredPapers().length === 0" class="text-center text-gray-600 dark:text-gray-400">No papers found 😢</p>
      <div class="grid gap-4 md:grid-cols-2 lg:grid-cols-3" x-show="filteredPapers().length > 0">
        <template x-for="(paper, index) in filteredPapers()" :key="index">
          <div class="p-4 bg-gray-50 dark:bg-gray-700 rounded-xl shadow hover:shadow-xl transition flex flex-col justify-between">
            <div>
              <h3 class="font-bold text-lg cursor-pointer hover:text-indigo-600 dark:hover:text-indigo-400"
                  @click="showDetails(paper)">
                  <span x-text="paper.title"></span>
              </h3>
              <p class="text-gray-600 dark:text-gray-300"><span x-text="paper.author"></span> — <span x-text="paper.year"></span></p>
              <p class="text-sm text-gray-500 dark:text-gray-400">Tags: <span x-text="paper.tags.join(', ')"></span></p>
            </div>
            <div class="mt-3 flex justify-between items-center">
              <a :href="paper.file" target="_blank" class="text-indigo-600 dark:text-indigo-400 font-medium hover:underline">📄 View</a>
              <div class="flex gap-2">
                <button @click="toggleFavorite(paper)" 
                        :class="paper.favorite ? 'text-yellow-400' : 'text-gray-400 dark:text-gray-500'"
                        class="text-xl">⭐</button>
                <button @click="removePaper(index)" class="bg-red-500 hover:bg-red-600 text-white px-3 py-1 rounded-lg text-sm">🗑</button>
              </div>
            </div>
          </div>
        </template>
      </div>
    </div>

    <!-- Favorites Section -->
    <div class="max-w-5xl mx-auto mt-10">
      <h2 class="text-2xl font-bold mb-4">⭐ Favorite Papers</h2>
      <div class="bg-white dark:bg-gray-800 p-6 rounded-2xl shadow-lg">
        <p x-show="favorites().length === 0" class="text-gray-600 dark:text-gray-400">No favorites yet.</p>
        <div class="grid gap-4 md:grid-cols-2 lg:grid-cols-3" x-show="favorites().length > 0">
          <template x-for="paper in favorites()" :key="paper.title">
            <div class="p-4 bg-yellow-50 dark:bg-yellow-900 rounded-xl shadow">
              <h3 class="font-bold text-lg" x-text="paper.title"></h3>
              <p class="text-gray-600 dark:text-gray-200"><span x-text="paper.author"></span> — <span x-text="paper.year"></span></p>
            </div>
          </template>
        </div>
      </div>
    </div>

    <!-- Paper Details Modal -->
    <div x-show="showModal" class="fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-50">
      <div class="bg-white dark:bg-gray-800 rounded-xl p-6 w-96 relative animate-fadeIn">
        <button @click="showModal=false" class="absolute top-2 right-2 text-gray-500 dark:text-gray-300">✖</button>
        <h2 class="text-2xl font-bold mb-2" x-text="modalPaper.title"></h2>
        <p class="text-gray-600 dark:text-gray-300 mb-2"><span x-text="modalPaper.author"></span> — <span x-text="modalPaper.year"></span></p>
        <p class="text-gray-700 dark:text-gray-200 mb-4" x-text="modalPaper.abstract || 'No abstract provided.'"></p>
        <a :href="modalPaper.file" target="_blank" class="bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-lg">📄 View Full Paper</a>
      </div>
    </div>

  </div>

  <script>
    // === Load Profile from localStorage ===
    const user = JSON.parse(localStorage.getItem("userProfile")) || {};
    if(user.name) document.getElementById("dashName").textContent = "Welcome, " + user.name;
    if(user.bio) document.getElementById("dashBio").textContent = user.bio;
    if(user.avatar) {
      document.getElementById("dashAvatar").src = user.avatar;
      document.getElementById("navAvatar").src = user.avatar;
      document.getElementById("navName").textContent = user.name;
    }

    // === Dashboard AlpineJS ===
    function paperDashboard() {
      return {
        papers: JSON.parse(localStorage.getItem("papers")) || [],
        search: "",
        sortBy: "",
        filterTag: "",
        showModal: false,
        modalPaper: {},
        removePaper(index) {
          this.papers.splice(index,1);
          localStorage.setItem("papers", JSON.stringify(this.papers));
        },
        filteredPapers() {
          let result = this.papers.filter(p =>
            (p.title.toLowerCase().includes(this.search.toLowerCase()) ||
             p.author.toLowerCase().includes(this.search.toLowerCase()) ||
             p.year.toString().includes(this.search)) &&
            (this.filterTag === "" || p.tags.includes(this.filterTag))
          );
          if(this.sortBy) {
            result.sort((a,b) => {
              if(this.sortBy==="year") return b.year-a.year;
              return a[this.sortBy].localeCompare(b[this.sortBy]);
            });
          }
          return result;
        },
        uniqueTags() {
          let tags = [];
          this.papers.forEach(p=>tags.push(...p.tags));
          return [...new Set(tags)];
        },
        toggleFavorite(paper) {
          paper.favorite = !paper.favorite;
          localStorage.setItem("papers", JSON.stringify(this.papers));
        },
        favorites() {
          return this.papers.filter(p=>p.favorite);
        },
        showDetails(paper) {
          this.modalPaper = paper;
          this.showModal = true;
        },
        exportCSV() {
          let csv = "Title,Author,Year,Tags\n"+
            this.papers.map(p=>`"${p.title}","${p.author}",${p.year},"${p.tags.join(';')}"`).join("\n");
          let blob = new Blob([csv], {type:'text/csv'});
          let link = document.createElement("a");
          link.href = URL.createObjectURL(blob);
          link.download="papers.csv";
          link.click();
        },
        papersThisYear() {
          let currentYear = new Date().getFullYear();
          return this.papers.filter(p=>p.year==currentYear).length;
        },
        topTag() {
          let counts = {};
          this.papers.forEach(p=>p.tags.forEach(tag=>counts[tag]=(counts[tag]||0)+1));
          return Object.keys(counts).length ? Object.entries(counts).sort((a,b)=>b[1]-a[1])[0][0] : "";
        }
      }
    }
  </script>
</body>
</html>
